---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: portalexposes.portal.gosuda.org
spec:
  group: portal.gosuda.org
  names:
    kind: PortalExpose
    listKind: PortalExposeList
    plural: portalexposes
    singular: portalexpose
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: PortalExpose is the Schema for the portalexposes API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of PortalExpose
            properties:
              app:
                description: App defines which application to expose
                properties:
                  name:
                    description: Name is the application name (becomes subdomain)
                    maxLength: 63
                    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                    type: string
                  service:
                    description: Service references the Kubernetes Service to expose
                    properties:
                      name:
                        description: Name is the Service name in the same namespace
                        type: string
                      port:
                        description: Port is the Service port number to expose
                        format: int32
                        maximum: 65535
                        minimum: 1
                        type: integer
                    required:
                    - name
                    - port
                    type: object
                required:
                - name
                - service
                type: object
              relay:
                description: Relay defines relay configuration
                properties:
                  targets:
                    description: Targets is the list of Portal relay endpoints
                    items:
                      description: RelayTarget defines a Portal relay endpoint
                      properties:
                        name:
                          description: Name is the relay identifier
                          type: string
                        url:
                          description: URL is the WebSocket relay URL
                          pattern: ^wss://.*
                          type: string
                      required:
                      - name
                      - url
                      type: object
                    minItems: 1
                    type: array
                required:
                - targets
                type: object
              tunnelClassName:
                description: |-
                  TunnelClassName references the TunnelClass to use
                  Uses default TunnelClass if omitted
                type: string
            required:
            - app
            - relay
            type: object
          status:
            description: status defines the observed state of PortalExpose
            properties:
              conditions:
                description: |-
                  Conditions represent the current state of the PortalExpose resource.
                  Standard condition types include:
                  - "Available": the resource is fully functional
                  - "Progressing": the resource is being created or updated
                  - "TunnelDeploymentReady": all tunnel pods are ready
                  - "RelayConnected": all relays are connected
                  - "ServiceExists": referenced Service was found
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              phase:
                description: 'Phase is the current state: Pending | Ready | Degraded
                  | Failed'
                enum:
                - Pending
                - Ready
                - Degraded
                - Failed
                type: string
              publicURL:
                description: PublicURL is the accessible endpoint (e.g., "https://my-app.portal.gosuda.org")
                type: string
              relay:
                description: Relay shows relay connection status
                properties:
                  connected:
                    description: Connected lists per-relay connection states
                    items:
                      description: RelayConnectionStatus represents relay connection
                        state
                      properties:
                        connectedAt:
                          description: ConnectedAt is when the connection was established
                          format: date-time
                          type: string
                        lastError:
                          description: LastError is the last connection error message
                          type: string
                        name:
                          description: Name is the relay name (matches spec.relay.targets[].name)
                          type: string
                        status:
                          description: 'Status is the connection status: Connected
                            | Disconnected | Unknown'
                          enum:
                          - Connected
                          - Disconnected
                          - Unknown
                          type: string
                      required:
                      - name
                      - status
                      type: object
                    type: array
                type: object
              tunnelPods:
                description: TunnelPods shows tunnel pod readiness
                properties:
                  ready:
                    description: Ready is the number of ready tunnel pods
                    format: int32
                    type: integer
                  total:
                    description: Total is the desired number of tunnel pods
                    format: int32
                    type: integer
                type: object
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: tunnelclasses.portal.gosuda.org
spec:
  group: portal.gosuda.org
  names:
    kind: TunnelClass
    listKind: TunnelClassList
    plural: tunnelclasses
    singular: tunnelclass
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: TunnelClass is the Schema for the tunnelclasses API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of TunnelClass
            properties:
              nodeSelector:
                additionalProperties:
                  type: string
                description: NodeSelector constrains tunnel pods to nodes with specific
                  labels
                type: object
              replicas:
                description: Replicas is the number of tunnel pod replicas
                format: int32
                minimum: 1
                type: integer
              size:
                description: 'Size defines the resource allocation tier: small | medium
                  | large'
                enum:
                - small
                - medium
                - large
                type: string
              tolerations:
                description: Tolerations allows tunnel pods to schedule on tainted
                  nodes
                items:
                  description: |-
                    The pod this Toleration is attached to tolerates any taint that matches
                    the triple <key,value,effect> using the matching operator <operator>.
                  properties:
                    effect:
                      description: |-
                        Effect indicates the taint effect to match. Empty means match all taint effects.
                        When specified, allowed values are NoSchedule, PreferNoSchedule and NoExecute.
                      type: string
                    key:
                      description: |-
                        Key is the taint key that the toleration applies to. Empty means match all taint keys.
                        If the key is empty, operator must be Exists; this combination means to match all values and all keys.
                      type: string
                    operator:
                      description: |-
                        Operator represents a key's relationship to the value.
                        Valid operators are Exists and Equal. Defaults to Equal.
                        Exists is equivalent to wildcard for value, so that a pod can
                        tolerate all taints of a particular category.
                      type: string
                    tolerationSeconds:
                      description: |-
                        TolerationSeconds represents the period of time the toleration (which must be
                        of effect NoExecute, otherwise this field is ignored) tolerates the taint. By default,
                        it is not set, which means tolerate the taint forever (do not evict). Zero and
                        negative values will be treated as 0 (evict immediately) by the system.
                      format: int64
                      type: integer
                    value:
                      description: |-
                        Value is the taint value the toleration matches to.
                        If the operator is Exists, the value should be empty, otherwise just a regular string.
                      type: string
                  type: object
                type: array
            required:
            - replicas
            - size
            type: object
          status:
            description: status defines the observed state of TunnelClass
            properties:
              conditions:
                description: Conditions represent the current state of the TunnelClass
                  resource.
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              observedGeneration:
                description: |-
                  ObservedGeneration is the last observed spec generation
                  Used for change detection
                format: int64
                type: integer
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: manager-role
rules:
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - portal.gosuda.org
  resources:
  - portalexposes
  - tunnelclasses
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - portal.gosuda.org
  resources:
  - portalexposes/finalizers
  - tunnelclasses/finalizers
  verbs:
  - update
- apiGroups:
  - portal.gosuda.org
  resources:
  - portalexposes/status
  - tunnelclasses/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/name: portal-expose
    app.kubernetes.io/managed-by: kustomize
  name: manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: manager-role
subjects:
- kind: ServiceAccount
  name: portal-expose-controller
  namespace: portal-expose-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/name: portal-expose
    app.kubernetes.io/managed-by: kustomize
  name: portal-expose-controller
  namespace: portal-expose-system
---
apiVersion: v1
kind: Namespace
metadata:
  name: portal-expose-system
---
apiVersion: portal.gosuda.org/v1alpha1
kind: TunnelClass
metadata:
  name: default
  annotations:
    portal.gosuda.org/is-default-class: "true"
spec:
  replicas: 1
  size: small
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: portal-expose-controller
  namespace: portal-expose-system
  labels:
    app.kubernetes.io/name: portal-expose-controller
    app.kubernetes.io/component: controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: portal-expose-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: portal-expose-controller
    spec:
      serviceAccountName: portal-expose-controller
      containers:
      - name: manager
        image: ghcr.io/gosuda/portal-expose-controller:0.1.0
        imagePullPolicy: IfNotPresent
        command:
        - /manager
        args:
        - --leader-elect
        env:
        - name: ENABLE_WEBHOOKS
          value: "false"
        ports:
        - containerPort: 8081
          name: health
          protocol: TCP
        - containerPort: 8080
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: health
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
